<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendify | Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
    --bg1:#f5f7ff;
    --bg2:#eef2ff;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;

    --blue:#6366f1;
    --blue-soft:#eef2ff;

    --green:#22c55e;
    --green-soft:#ecfdf5;

    --orange:#f97316;
    --border:#e5e7eb;
}

*{ box-sizing:border-box; }

body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--text);
}

/* Header */
.header{
    height:60px;
    background:linear-gradient(90deg,#6366f1,#818cf8);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 22px;
}

.header h1{
    font-size:16px;
    font-weight:600;
    margin:0;
}

.header button{
    background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);
    color:#fff;
    padding:7px 12px;
    border-radius:10px;
    cursor:pointer;
    font-size:13px;
}

/* Layout */
.main{
    max-width:700px;
    margin:40px auto;
    padding:0 16px;
}

/* Card */
.card{
    background:var(--card);
    border-radius:20px;
    padding:24px;
    box-shadow:
        0 12px 30px rgba(0,0,0,.08),
        inset 0 1px 0 rgba(255,255,255,.6);
}

.card-title{
    font-size:15px;
    font-weight:600;
    margin-bottom:18px;
    display:flex;
    align-items:center;
    gap:8px;
}

.card-title span{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--blue);
}

/* Form */
.form{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
}

.field{
    display:flex;
    flex-direction:column;
    gap:6px;
}

label{
    font-size:12px;
    color:var(--muted);
}

input{
    height:42px;
    padding:0 12px;
    border-radius:12px;
    border:1px solid var(--border);
    font-size:14px;
    background:#fafafa;
}

input:focus{
    outline:none;
    border-color:var(--blue);
    background:#fff;
}

/* Button */
.actions{
    margin-top:20px;
}

.actions button{
    width:100%;
    height:48px;
    border:none;
    border-radius:16px;
    background:linear-gradient(135deg,#6366f1,#4f46e5);
    color:#fff;
    font-size:15px;
    font-weight:500;
    cursor:pointer;
    box-shadow:0 8px 18px rgba(99,102,241,.35);
}

/* QR */
.qr{
    margin-top:28px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
}

.qr img{
    width:220px;
    padding:16px;
    background:linear-gradient(180deg,#ffffff,#f3f4f6);
    border-radius:22px;
    border:2px dashed var(--blue);
}

/* Countdown badge */
.countdown{
    padding:6px 14px;
    border-radius:999px;
    font-size:13px;
    font-weight:500;
    background:var(--green-soft);
    color:var(--green);
}

/* Hint */
.hint{
    font-size:12px;
    color:var(--muted);
    text-align:center;
}
</style>
</head>

<body>

<div class="header">
    <h1>Attendify</h1>
    <button onclick="logout()">Logout</button>
</div>

<div class="main">
<div class="card">

<div class="card-title">
    <span></span>
    Create Attendance QR
</div>

<div class="form">
    <div class="field">
        <label>Subject</label>
        <input id="subject" placeholder="DBMS">
    </div>

    <div class="field">
        <label>Section</label>
        <input id="section" placeholder="CSE-A">
    </div>

    <div class="field">
        <label>Valid till</label>
        <input id="endTime" type="time">
    </div>

    <div class="field">
        <label>Radius (meters)</label>
        <input id="radius" type="number" placeholder="50">
    </div>
</div>

<div class="actions">
    <button onclick="generateQR()">Generate QR</button>
</div>

<div class="qr">
    <img id="qrImg" alt="">
    <div class="countdown" id="countdown">—</div>
    <div class="hint">Scan allowed only within time & radius</div>
</div>

</div>
</div>

<script>
let expiryTime = null;
let timer = null;

function logout(){
    localStorage.clear();
    location.href = "login.html";
}

function startCountdown(){
    clearInterval(timer);

    timer = setInterval(()=>{
        const now = new Date();
        const diff = expiryTime - now;

        if(diff <= 0){
            document.getElementById("countdown").innerText = "QR Expired ❌";
            document.getElementById("countdown").style.background = "#fee2e2";
            document.getElementById("countdown").style.color = "#dc2626";
            clearInterval(timer);
            return;
        }

        const m = Math.floor(diff / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        document.getElementById("countdown").innerText =
            `⏱ ${m}m ${s}s left`;
    },1000);
}

function generateQR(){
    const subjectVal = subject.value;
    const sectionVal = section.value;
    const timeVal = endTime.value;
    const radiusVal = Number(radius.value);

    if(!subjectVal || !sectionVal || !timeVal || !radiusVal){
        alert("Please fill all fields");
        return;
    }

    const now = new Date();
    const [h,m] = timeVal.split(":");
    expiryTime = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        h,m
    );

    navigator.geolocation.getCurrentPosition(pos=>{
        const payload = {
            subject: subjectVal,
            section: sectionVal,
            radius: radiusVal,
            facultyLocation:{
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            },
            expiry: expiryTime.toISOString()
        };

        fetch("http://127.0.0.1:5000/generate-qr",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ payload })
        })
        .then(r=>r.json())
        .then(d=>{
            qrImg.src = d.qr;
            startCountdown();
        });

    },()=>{
        alert("Location permission required");
    });
}
</script>

</body>
</html>
