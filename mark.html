<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendify | Mark Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, Arial;
    background:linear-gradient(180deg,#f5f7ff,#eef2ff);
    display:flex;
    align-items:center;
    justify-content:center;
}
.card{
    background:#fff;
    padding:28px;
    width:340px;
    border-radius:18px;
    box-shadow:0 20px 40px rgba(0,0,0,.15);
    text-align:center;
}
.field{
    display:flex;
    flex-direction:column;
    text-align:left;
    margin-top:12px;
}
label{
    font-size:13px;
    margin-bottom:4px;
}
input{
    height:40px;
    padding:0 10px;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:14px;
}
button{
    margin-top:18px;
    width:100%;
    height:44px;
    border:none;
    border-radius:12px;
    background:#6366f1;
    color:#fff;
    font-size:15px;
    cursor:pointer;
}
.status{
    margin-top:14px;
    font-size:15px;
}
.success{ color:#16a34a; }
.error{ color:#dc2626; }
</style>
</head>

<body>

<div class="card">
    <h2>Attendify</h2>
    <p>Enter details to mark attendance</p>

    <div class="field">
        <label>Name</label>
        <input id="name" placeholder="Your full name">
    </div>

    <div class="field">
        <label>Roll Number</label>
        <input id="roll" placeholder="Roll No">
    </div>

    <button onclick="markAttendance()">Submit Attendance</button>

    <div class="status" id="status"></div>
</div>

<script>
function getDeviceId(){
    let id = localStorage.getItem("device_id");
    if(!id){
        id = crypto.randomUUID();
        localStorage.setItem("device_id", id);
    }
    return id;
}

const token = new URLSearchParams(location.search).get("token");
const statusBox = document.getElementById("status");

function markAttendance(){
    const name = document.getElementById("name").value.trim();
    const roll = document.getElementById("roll").value.trim();

    if(!name || !roll){
        statusBox.className="status error";
        statusBox.innerText="Please enter name and roll number";
        return;
    }

    statusBox.innerText="Checking location…";

    navigator.geolocation.getCurrentPosition(pos=>{
        fetch("/api/attendance/mark",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                token: token,
                device_id: getDeviceId(),
                name: name,
                roll: roll,
                studentLocation:{
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                }
            })
        })
        .then(r=>r.json())
        .then(res=>{
            if(res.status==="success"){
                statusBox.className="status success";
                statusBox.innerText =
                    `✅ Attendance marked\nDistance: ${res.distance} m`;
            }else{
                statusBox.className="status error";
                statusBox.innerText =
                    "❌ " + res.status.replace("_"," ");
            }
        });
    },()=>{
        statusBox.className="status error";
        statusBox.innerText="Location permission required";
    });
}
</script>

</body>
</html>
